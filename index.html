<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request for Proposal (Commercial PV)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #000000;
            color: #fff;
            padding: 20px;
        }
        h1 {
            color: #ffffff;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="email"], select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #212120;
            border-radius: 4px;
        }
        .required {
            color: red;
        }
        .optional {
            color: gray;
        }
        .btn-submit, .btn-new, .btn-dashboard {
            background-color: #212120;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .hidden {
            display: none;
        }
            /* Style for Select2 container */
    .select2-container--default .select2-selection--single {
        background-color: #212120; /* Dark background */
        color: #fff; /* White text */
        border: 1px solid #333; /* Border color */
        border-radius: 4px;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #fff; /* White text inside the selected item */
    }

    /* Style for the dropdown list */
    .select2-container--default .select2-results__options {
        background-color: #212120; /* Dark background */
        color: #fff; /* White text */
    }

    .select2-container--default .select2-results__option {
        color: #fff; /* White text for each option */
    }

    .select2-container--default .select2-results__option--highlighted {
        background-color: #333; /* Darker background for highlighted option */
        color: #fff; /* White text for highlighted option */
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        top: 50%;
        transform: translateY(-50%);
        border-color: #333 transparent transparent transparent; /* Arrow color */
    }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
</head>
<body>

<h1>Request for Proposal (Commercial PV)</h1>

<form id="rfp-form">
    <div class="form-group">
        <label for="rep-name">Rep Name <span class="required">*</span></label>
        <input type="text" id="rep-name" name="repName" required>
    </div>
    <div class="form-group">
        <label for="rep-email">Rep Email <span class="required">*</span></label>
        <input type="email" id="rep-email" name="repEmail" required>
    </div>
    <div class="form-group">
        <label for="customer-name">Customer Name (POC)</label>
        <input type="text" id="customer-name" name="customerName">
    </div>
    <div class="form-group">
        <label for="company-name">Company Name <span class="required">*</span></label>
        <input type="text" id="company-name" name="companyName" required>
    </div>
    <div class="form-group">
        <label for="company-email">Email <span class="required">*</span> <span class="optional">(Phone or Email required for tracking)</span></label>
        <input type="email" id="company-email" name="companyEmail">
    </div>
    <div class="form-group">
        <label for="company-address">Company Address <span class="required">*</span></label>
        <input type="text" id="company-address" name="companyAddress" required>
    </div>
    <div class="form-group">
        <label for="state">State <span class="required">*</span></label>
        <select id="state" name="state" required>
        </select>
    </div>
    <div class="form-group">
        <label for="city">Nearest City <span class="required">*</span></label>
        <select id="city" name="city" required style="width: 100%;">
        </select>
    </div>
    <div class="form-group">
        <label for="install-location">Install Location (Coordinates) <span class="optional">(Desired location of Panels)</span></label>
        <input type="text" id="install-location" name="installLocation">
    </div>
    <div class="form-group">
        <label for="usage-type">Usage Type</label>
        <select id="usage-type" name="usageType">
            <option value="monthly">Monthly</option>
            <option value="daily">Daily</option>
        </select>
    </div>
    <div class="form-group">
        <label for="january">January</label>
        <input type="number" id="january" name="january">
    </div>
    <div class="form-group">
        <label for="february">February</label>
        <input type="number" id="february" name="february">
    </div>
    <div class="form-group">
        <label for="march">March</label>
        <input type="number" id="march" name="march">
    </div>
    <div class="form-group">
        <label for="april">April</label>
        <input type="number" id="april" name="april">
    </div>
    <div class="form-group">
        <label for="may">May</label>
        <input type="number" id="may" name="may">
    </div>
    <div class="form-group">
        <label for="june">June</label>
        <input type="number" id="june" name="june">
    </div>
    <div class="form-group">
        <label for="july">July</label>
        <input type="number" id="july" name="july">
    </div>
    <div class="form-group">
        <label for="august">August</label>
        <input type="number" id="august" name="august">
    </div>
    <div class="form-group">
        <label for="september">September</label>
        <input type="number" id="september" name="september">
    </div>
    <div class="form-group">
        <label for="october">October</label>
        <input type="number" id="october" name="october">
    </div>
    <div class="form-group">
        <label for="november">November</label>
        <input type="number" id="november" name="november">
    </div>
    <div class="form-group">
        <label for="december">December</label>
        <input type="number" id="december" name="december">
    </div>
    <div class="form-group">
        <label for="rfp-delivery-date">RFP Delivery Date</label>
        <input type="datetime-local" 
               id="rfp-delivery-date" 
               name="rfpDeliveryDate" 
               min="2024-01-01T00:00" 
               max="2050-12-31T23:59" 
               step="1">
    </div>

    <!-- Hidden fields for IDs -->
    <input type="hidden" id="rep-id" name="repId">
    <input type="hidden" id="company-id" name="companyId">
    <input type="hidden" id="rfp-id" name="rfpId">

    <button type="submit" class="btn-submit">Submit</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const csvUrl = 'https://lckdin-files.s3.us-east-2.amazonaws.com/App/City_State+-+Sheet1+(3).csv';
    const stateCityMap = {};
    const statesSet = new Set();

    // Load and parse the CSV file
    Papa.parse(csvUrl, {
        download: true,
        header: true,
        complete: function(results) {
            console.log(results.data); // Debugging
            results.data.forEach(row => {
                const state = row.State;
                const city = row.City;

                if (!stateCityMap[state]) {
                    stateCityMap[state] = [];
                }
                stateCityMap[state].push(city);
                statesSet.add(state);
            });

            populateStateDropdown();
        }
    });

    // Function to populate the state dropdown
    function populateStateDropdown() {
        const stateSelect = document.getElementById('state');
        stateSelect.innerHTML = '';

        const sortedStates = Array.from(statesSet).sort();
        sortedStates.forEach(state => {
            const option = document.createElement('option');
            option.value = state;
            option.textContent = state;
            stateSelect.appendChild(option);
        });

        stateSelect.addEventListener('change', function() {
            populateCityDropdown(this.value);
        });
    }

    // Function to populate the city dropdown based on the selected state
    function populateCityDropdown(state) {
        const citySelect = $('#city');
        citySelect.empty();

        if (stateCityMap[state]) {
            const sortedCities = stateCityMap[state].sort();
            sortedCities.forEach(city => {
                const option = new Option(city, city, false, false);
                citySelect.append(option);
            });
        }

        citySelect.trigger('change');
    }

    // Initialize the city dropdown with Select2
    $('#city').select2({
        placeholder: 'Select a city',
        allowClear: true
    });

    // Function to generate a hash from input strings
    function generateHash(input) {
        return CryptoJS.MD5(input).toString(CryptoJS.enc.Hex).substring(0, 5);
    }

    // Listen for form submission
    const form = document.getElementById('rfp-form');
    form.addEventListener('submit', async function(event) {
        // Prevent the default form submission
        event.preventDefault();

        // Get the rep name and email
        const repName = document.getElementById('rep-name').value;
        const repEmail = document.getElementById('rep-email').value;

        // Get the company name and email
        const companyName = document.getElementById('company-name').value;
        const companyEmail = document.getElementById('company-email').value;

        // Generate and set the IDs
        document.getElementById('rep-id').value = generateHash(repName + repEmail);
        document.getElementById('company-id').value = 'C' + generateHash(companyName + companyEmail);
        document.getElementById('rfp-id').value = 'R' + generateHash(Date.now().toString());

        // Prepare form data
        const formData = new FormData(form);

        // Send data to the server via POST request
        try {
            const response = await fetch('https://script.google.com/macros/s/AKfycbyp5fnAHEc_kNyVP0VDCJvzvcNG72djN7_z9VDtgc2IVLKFeTPZBhwpJbpnohEu5AAu/exec', {
                method: 'POST',
                body: formData
            });

            const result = await response.text();

            if (result === 'Success') {
                alert('RFP submitted successfully!');
                window.location.href = 'confirmation.html?message=RFP Received';
            } else {
                alert('Failed to submit RFP. Please try again.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Failed to submit RFP. Please try again.');
        }
    });
});
</script>
